// SPDX-License-Identifier: Apache-2.0

package main

import (
	"io/ioutil"
	"os"
	"os/exec"
	"path/filepath"
	"strings"
	"text/template"

	"github.com/go-interpreter/wagon/wasm"
	"golang.org/x/tools/go/packages"
)

func main() {
	if err := run(); err != nil {
		panic(err)
	}
}

func identifierFromString(str string) string {
	str = strings.ReplaceAll(str, ".", "_")
	str = strings.ReplaceAll(str, "-", "_")
	str = strings.ReplaceAll(str, "/", "_")
	// TODO: __ might be preserved. Use a better conversion rule.
	/*for strings.Contains(str, "__") {
		str = strings.ReplaceAll(str, "__", "_")
	}*/
	return str
}

func namespaceFromPkg(pkg *packages.Package) string {
	ts := strings.Split(pkg.PkgPath, "/")
	for i, t := range ts {
		ts[i] = identifierFromString(t)
	}
	return strings.Join(ts, ".")
}

type Func struct {
	Index        int
	OriginalName string
	Name         string
}

func run() error {
	tmp, err := ioutil.TempDir("", "go2dotnet-")
	if err != nil {
		return err
	}
	defer os.RemoveAll(tmp)

	wasmpath := filepath.Join(tmp, "tmp.wasm")

	// TODO: Detect the last argument is path or not
	pkgname := os.Args[len(os.Args)-1]

	args := append([]string{"build"}, os.Args[1:]...)
	args = append(args[:len(args)-1], "-o="+wasmpath, pkgname)
	cmd := exec.Command("go", args...)
	cmd.Stderr = os.Stderr
	cmd.Env = append(os.Environ(), "GOOS=js", "GOARCH=wasm")
	if err := cmd.Run(); err != nil {
		return err
	}

	f, err := os.Open(wasmpath)
	if err != nil {
		return err
	}
	defer f.Close()

	mod, err := wasm.ReadModule(f, nil)
	if err != nil {
		return err
	}

	var ifs []*Func
	var fs []*Func
	for i, f := range mod.FunctionIndexSpace {
		if f.Name == "" {
			name := mod.Import.Entries[i].FieldName
			ifs = append(ifs, &Func{
				Index:        i,
				OriginalName: name,
				Name:         identifierFromString(name),
			})
			continue
		}
		name := f.Name
		fs = append(fs, &Func{
			Index:        i,
			OriginalName: name,
			Name:         identifierFromString(name),
		})
	}

	pkgs, err := packages.Load(nil, pkgname)
	if err != nil {
		return err
	}

	namespace := namespaceFromPkg(pkgs[0])
	class := identifierFromString(pkgs[0].Name)

	t := template.Must(template.New("out.cs").Parse(tmpl))
	if err := t.Execute(os.Stdout, struct {
		Namespace   string
		Class       string
		ImportFuncs []*Func
		Funcs       []*Func
	}{
		Namespace:   namespace,
		Class:       class,
		ImportFuncs: ifs,
		Funcs:       fs,
	}); err != nil {
		return err
	}

	return nil
}

const tmpl = `// Code generated by go2dotnet. DO NOT EDIT.

namespace {{.Namespace}}
{
    sealed class Import
    {
{{- range $value := .ImportFuncs}}
        // OriginalName: {{$value.OriginalName}}
        // Index:        {{$value.Index}}
        internal void {{$value.Name}}()
        {
            // TODO: Implement this.
        }
{{end}}    }

    sealed class Go_{{.Class}}
    {
{{- range $value := .Funcs}}
        // OriginalName: {{$value.OriginalName}}
        // Index:        {{$value.Index}}
        private void {{$value.Name}}()
        {
            // TODO: Implement this.
        }
{{end}}    }
}
`
